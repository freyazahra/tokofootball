{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 mt-8">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold mb-1">{{ app_name }}</h1>    
            <p class="text-gray-600 mb-0">
                Welcome, <strong class="font-semibold">{{ user.username }}</strong> | 
                Last login: {{ last_login }}
            </p>
        </div>
        <!-- Add Product Button - Opens modal -->
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2" onclick="showAddProductModal()">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Add New Product
        </button>
    </div>

    <!-- Filter and Search Section -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-8">
        <div class="md:col-span-8">
            <form method="GET" action="{% url 'main:show_main' %}" class="flex gap-2">
                <input type="text" name="q" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Search products..." value="{{ queries }}">
                <button type="submit" class="bg-white border border-blue-600 text-blue-600 hover:bg-blue-50 font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    Search
                </button>
            </form>
        </div>
        <div class="md:col-span-4">
            <div class="inline-flex rounded-lg border border-gray-300 w-full" role="group">
                <a href="?filter=all" class="flex-1 text-center px-4 py-2 text-sm font-medium border-r border-gray-300 rounded-l-lg {% if request.GET.filter == 'all' or not request.GET.filter %}bg-gray-200 text-gray-900{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} transition-colors">
                    All Products
                </a>
                <a href="?filter=my" class="flex-1 text-center px-4 py-2 text-sm font-medium rounded-r-lg {% if request.GET.filter == 'my' %}bg-gray-200 text-gray-900{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} transition-colors">
                    My Products
                </a>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {% for product in products %}
        <div class="bg-white rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200 flex flex-col h-full">
            <!-- Product Thumbnail -->
            <div class="relative">
                {% if product.thumbnail %}
                <img src="{{ product.thumbnail }}" 
                     class="w-full h-48 object-cover rounded-t-lg cursor-pointer hover:opacity-90 transition-opacity" 
                     alt="{{ product.name }}"
                     onclick="showProductDetailModal('{{ product.id }}')"
                     onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                {% else %}
                <div class="w-full h-48 bg-gray-400 flex items-center justify-center rounded-t-lg cursor-pointer" 
                     onclick="showProductDetailModal('{{ product.id }}')">
                    <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                        <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                    </svg>
                </div>
                {% endif %}
                
                <!-- Featured Badge -->
                {% if product.is_featured %}
                <span class="absolute top-2 right-2">
                    <span class="inline-flex items-center gap-1 bg-yellow-400 text-gray-900 text-xs font-semibold px-2 py-1 rounded">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                        </svg>
                        Featured
                    </span>
                </span>
                {% endif %}
            </div>
            
            <div class="p-4 flex flex-col flex-grow">
                <!-- Product Name -->
                <h5 class="text-lg font-semibold mb-2">{{ product.name|truncatechars:30 }}</h5>
                
                <!-- Category -->
                <p class="text-gray-600 text-sm mb-2 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2 2a1 1 0 0 1 1-1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 2 6.586V2zm3.5 4a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                    </svg>
                    {{ product.category }}
                </p>
                
                <!-- Description -->
                <p class="text-gray-600 text-sm flex-grow mb-3">
                    {{ product.description|truncatewords:15 }}
                </p>
                
                <!-- Price -->
                <p class="text-green-600 font-bold text-xl mb-3">
                    Rp {{ product.price|floatformat:0 }}
                </p>
                
                <!-- Action Buttons -->
                <div class="flex flex-col gap-2" role="group">
                    <!-- View Detail Button - Opens Modal -->
                    <button class="w-full bg-white border border-cyan-600 text-cyan-600 hover:bg-cyan-50 font-medium py-2 px-3 rounded-lg transition-colors text-sm flex items-center justify-center gap-2" onclick="showProductDetailModal('{{ product.id }}')">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                        </svg>
                        View Details
                    </button>
                    
                    <div class="flex gap-2" role="group">
                        <!-- Edit Button - Opens Modal -->
                        <button class="flex-1 bg-white border border-yellow-500 text-yellow-600 hover:bg-yellow-50 font-medium py-2 px-3 rounded-lg transition-colors text-sm flex items-center justify-center gap-2" onclick="showEditProductModal('{{ product.id }}')">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                            </svg>
                            Edit
                        </button>
                        
                        <!-- Delete Button - Confirmation Dialog -->
                        <button class="flex-1 bg-white border border-red-600 text-red-600 hover:bg-red-50 font-medium py-2 px-3 rounded-lg transition-colors text-sm flex items-center justify-center gap-2" onclick="deleteProduct('{{ product.id }}')">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full">
            <div class="bg-blue-50 border border-blue-200 rounded-lg text-center py-12 px-4">
                <svg class="w-16 h-16 mx-auto text-blue-400 mb-4" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
                </svg>
                <h4 class="text-xl font-semibold text-gray-900 mb-2">No products found</h4>
                <p class="text-gray-600 mb-4">
                    {% if queries %}
                        No products match your search "{{ queries }}".
                    {% else %}
                        Start by adding your first product!
                    {% endif %}
                </p>
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors inline-flex items-center gap-2" onclick="showAddProductModal()">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Add Your First Product
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Container -->
<div id="modalContainer" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div id="modalContent"></div>
    </div>
</div>

<script>
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');

    // Show Add Product Modal
    function showAddProductModal() {
        fetch('/create-product-ajax/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('modalContent').innerHTML = data.html;
                document.getElementById('modalContainer').classList.remove('hidden');
                document.getElementById('modalContainer').classList.add('flex');
            })
            .catch(error => console.error('Error:', error));
    }

    // Show Edit Product Modal
    function showEditProductModal(productId) {
        fetch(`/edit-product-ajax/${productId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modalContent').innerHTML = data.html;
                document.getElementById('modalContainer').classList.remove('hidden');
                document.getElementById('modalContainer').classList.add('flex');
            })
            .catch(error => console.error('Error:', error));
    }

    // Show Product Detail Modal
    function showProductDetailModal(productId) {
        fetch(`/product-detail-ajax/${productId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modalContent').innerHTML = data.html;
                document.getElementById('modalContainer').classList.remove('hidden');
                document.getElementById('modalContainer').classList.add('flex');
            })
            .catch(error => console.error('Error:', error));
    }

    // Close Modal
    function closeModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('modalContainer').classList.add('hidden');
        document.getElementById('modalContainer').classList.remove('flex');
        document.getElementById('modalContent').innerHTML = '';
    }

    // Submit Form (for Add/Edit)
    function submitProductForm(event, actionUrl) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch(actionUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal();
                location.reload(); // Reload to show updated products
            } else {
                // Show errors in form
                alert(data.message || 'Please correct the errors in the form.');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Delete Product
    function deleteProduct(productId) {
        if (confirm('Are you sure you want to delete this product?')) {
            fetch(`/delete-product-ajax/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated products
                } else {
                    alert(data.message || 'Failed to delete product.');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}